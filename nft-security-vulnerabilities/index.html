<!doctype html>
<html lang="zh-CN" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">NFT智能合约安全漏洞全解析 | AutoSec</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://pfyangf.github.io/img/social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://pfyangf.github.io/img/social-card.jpg"><meta data-rh="true" property="og:url" content="https://pfyangf.github.io/nft-security-vulnerabilities/"><meta data-rh="true" property="og:locale" content="zh_CN"><meta data-rh="true" property="og:locale:alternate" content="en_US"><meta data-rh="true" name="docusaurus_locale" content="zh-CN"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="zh-CN"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" name="keywords" content="Web3 Security, Blockchain Security, Smart Contract Audit, DeFi Security, Cryptocurrency Security, Bug Bounty, Vulnerability Research, Ethereum Security, Solidity Security"><meta data-rh="true" name="author" content="AutoSec Team"><meta data-rh="true" property="og:title" content="NFT智能合约安全漏洞全解析 | AutoSec"><meta data-rh="true" name="description" content="NFT（非同质化代币）市场在2021-2023年间爆发式增长，但随之而来的是各种安全问题。从合约漏洞到钓鱼攻击，NFT生态系统面临着多重安全挑战。"><meta data-rh="true" property="og:description" content="NFT（非同质化代币）市场在2021-2023年间爆发式增长，但随之而来的是各种安全问题。从合约漏洞到钓鱼攻击，NFT生态系统面临着多重安全挑战。"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2025-02-02T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://autosec.dev"><meta data-rh="true" property="article:tag" content="NFT安全,ERC-721,ERC-1155,智能合约,Web3安全"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://pfyangf.github.io/nft-security-vulnerabilities/"><link data-rh="true" rel="alternate" href="https://pfyangf.github.io/nft-security-vulnerabilities/" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://pfyangf.github.io/en/nft-security-vulnerabilities/" hreflang="en-US"><link data-rh="true" rel="alternate" href="https://pfyangf.github.io/nft-security-vulnerabilities/" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://pfyangf.github.io/nft-security-vulnerabilities","mainEntityOfPage":"https://pfyangf.github.io/nft-security-vulnerabilities","url":"https://pfyangf.github.io/nft-security-vulnerabilities","headline":"NFT智能合约安全漏洞全解析","name":"NFT智能合约安全漏洞全解析","description":"NFT（非同质化代币）市场在2021-2023年间爆发式增长，但随之而来的是各种安全问题。从合约漏洞到钓鱼攻击，NFT生态系统面临着多重安全挑战。","datePublished":"2025-02-02T00:00:00.000Z","author":{"@type":"Person","name":"AutoSec Team","description":"Web3 Security Researchers","url":"https://autosec.dev","image":"/img/autosec.logo.png"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://pfyangf.github.io/","name":"Security Research"}}</script><link rel="stylesheet" href="/assets/css/styles.8fba4a29.css">
<script src="/assets/js/runtime~main.6a9a3182.js" defer="defer"></script>
<script src="/assets/js/main.8c0c1f75.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/autosec.png" alt="AutoSec Logo" class="themedComponent_mlkZ themedComponent--light_NVdE" height="60" width="180"><img src="/img/autosec.png" alt="AutoSec Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU" height="60" width="180"></div><b class="navbar__title text--truncate">AutoSec</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">研究</a><a class="navbar__item navbar__link" href="/tags/">主题</a><a class="navbar__item navbar__link" href="/archive/">归档</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>简体中文</a><ul class="dropdown__menu"><li><a href="/nft-security-vulnerabilities/" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-CN">简体中文</a></li><li><a href="/en/nft-security-vulnerabilities/" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en-US">English</a></li></ul></div><a href="https://github.com/pfyangf/pfyangf.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="切换浅色/暗黑模式（当前为system mode）"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">最近文章</div><div role="group"><h3 class="yearGroupHeading_rMGB">2026</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zero-knowledge-proofs-security/">零知识证明在Web3安全中的应用：从理论到实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/mev-attacks-prevention/">MEV攻击全景图：从三明治攻击到防御策略</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2025</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/reentrancy-attack-analysis/">深度解析：重入攻击及其防御策略</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/defi-flash-loan-attacks/">DeFi闪电贷攻击深度剖析：原理、案例与防御</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/cross-chain-bridge-security/">Cross-Chain Bridge Security: Vulnerabilities and Best Practices</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/nft-security-vulnerabilities/">NFT智能合约安全漏洞全解析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/react-hooks-guide/">React Hooks 完全指南</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/solidity-security-patterns/">Solidity Security Patterns: Writing Secure Smart Contracts</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/web3-wallet-security/">Web3钱包安全完全指南：从原理到实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/typescript-best-practices/">TypeScript 最佳实践指南</a></li></ul></div></nav></aside><main class="col col--7"><article class=""><header><h1 class="title_f1Hy">NFT智能合约安全漏洞全解析</h1><div class="container_mt6G margin-vert--md"><time datetime="2025-02-02T00:00:00.000Z">2025年2月2日</time> · <!-- -->阅读需 7 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://autosec.dev" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="/img/autosec.logo.png" alt="AutoSec Team"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://autosec.dev" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp" translate="no">AutoSec Team</span></a></div><small class="authorTitle_nd0D" title="Web3 Security Researchers">Web3 Security Researchers</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><p>NFT（非同质化代币）市场在2021-2023年间爆发式增长，但随之而来的是各种安全问题。从合约漏洞到钓鱼攻击，NFT生态系统面临着多重安全挑战。</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="nft标准概述">NFT标准概述<a href="#nft标准概述" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="erc-721-vs-erc-1155">ERC-721 vs ERC-1155<a href="#erc-721-vs-erc-1155" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接" translate="no">​</a></h3>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// ERC-721: 每个代币都是唯一的</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">interface IERC721 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function ownerOf(uint256 tokenId) external view returns (address);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function transferFrom(address from, address to, uint256 tokenId) external;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function safeTransferFrom(address from, address to, uint256 tokenId) external;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ERC-1155: 支持批量操作和半同质化代币</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">interface IERC1155 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function balanceOf(address account, uint256 id) external view returns (uint256);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function safeBatchTransferFrom(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        address from,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        address to,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        uint256[] calldata ids,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        uint256[] calldata amounts,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bytes calldata data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ) external;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="常见安全漏洞">常见安全漏洞<a href="#常见安全漏洞" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1-重入攻击">1. 重入攻击<a href="#1-重入攻击" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接" translate="no">​</a></h3>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 存在重入漏洞的NFT合约</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">contract VulnerableNFT is ERC721 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint256 public constant PRICE = 0.1 ether;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function mint() external payable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        require(msg.value &gt;= PRICE, &quot;Insufficient payment&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        uint256 tokenId = totalSupply();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _safeMint(msg.sender, tokenId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 危险：在铸造后退款</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (msg.value &gt; PRICE) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            (bool success, ) = msg.sender.call{value: msg.value - PRICE}(&quot;&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            require(success, &quot;Refund failed&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 攻击合约</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">contract NFTAttacker is IERC721Receiver {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    VulnerableNFT public nft;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint256 public attackCount;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function attack() external payable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        nft.mint{value: msg.value}();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function onERC721Received(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        address,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        address,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        uint256,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bytes memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ) public override returns (bytes4) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 重入攻击</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (attackCount &lt; 10 &amp;&amp; address(nft).balance &gt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            attackCount++;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nft.mint{value: 0.1 ether}();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return this.onERC721Received.selector;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    receive() external payable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 在退款时重入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (address(nft).balance &gt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nft.mint{value: 0.1 ether}();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p><strong>修复方案：</strong></p>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">contract SecureNFT is ERC721, ReentrancyGuard {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint256 public constant PRICE = 0.1 ether;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function mint() external payable nonReentrant {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        require(msg.value &gt;= PRICE, &quot;Insufficient payment&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        uint256 tokenId = totalSupply();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 先更新状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _mint(msg.sender, tokenId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 最后处理退款</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (msg.value &gt; PRICE) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            (bool success, ) = msg.sender.call{value: msg.value - PRICE}(&quot;&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            require(success, &quot;Refund failed&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="2-元数据操纵">2. 元数据操纵<a href="#2-元数据操纵" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接" translate="no">​</a></h3>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 不安全：元数据可以被修改</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">contract UnsafeMetadata is ERC721 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mapping(uint256 =&gt; string) public tokenURIs;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function setTokenURI(uint256 tokenId, string memory uri) external {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 任何人都可以修改！</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tokenURIs[tokenId] = uri;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 安全实现</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">contract SecureMetadata is ERC721 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    string private baseURI;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mapping(uint256 =&gt; bytes32) public immutableMetadata;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    constructor(string memory _baseURI) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        baseURI = _baseURI;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function mint(uint256 tokenId, bytes32 metadataHash) external {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _mint(msg.sender, tokenId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 元数据哈希不可变</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        immutableMetadata[tokenId] = metadataHash;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function tokenURI(uint256 tokenId) public view override returns (string memory) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        require(_exists(tokenId), &quot;Token does not exist&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return string(abi.encodePacked(baseURI, Strings.toString(tokenId)));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 验证元数据完整性</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function verifyMetadata(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        uint256 tokenId,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        string memory metadata</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ) external view returns (bool) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return keccak256(bytes(metadata)) == immutableMetadata[tokenId];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="3-访问控制漏洞">3. 访问控制漏洞<a href="#3-访问控制漏洞" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接" translate="no">​</a></h3>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 漏洞：缺少访问控制</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">contract VulnerableNFTMint is ERC721 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function mint(address to, uint256 tokenId) external {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 任何人都可以铸造！</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _mint(to, tokenId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 安全实现</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">contract SecureNFTMint is ERC721, Ownable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint256 public maxSupply = 10000;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint256 public totalMinted;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mapping(address =&gt; bool) public whitelist;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 白名单铸造</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function whitelistMint() external {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        require(whitelist[msg.sender], &quot;Not whitelisted&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        require(totalMinted &lt; maxSupply, &quot;Max supply reached&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        whitelist[msg.sender] = false; // 防止重复铸造</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _mint(msg.sender, totalMinted);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        totalMinted++;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 公开铸造（带限制）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mapping(address =&gt; uint256) public mintedPerAddress;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint256 public constant MAX_PER_ADDRESS = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function publicMint(uint256 amount) external payable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        require(amount &lt;= MAX_PER_ADDRESS, &quot;Exceeds max per tx&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        require(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            mintedPerAddress[msg.sender] + amount &lt;= MAX_PER_ADDRESS,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;Exceeds max per address&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        require(totalMinted + amount &lt;= maxSupply, &quot;Exceeds max supply&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        require(msg.value &gt;= PRICE * amount, &quot;Insufficient payment&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (uint256 i = 0; i &lt; amount; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            _mint(msg.sender, totalMinted);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            totalMinted++;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mintedPerAddress[msg.sender] += amount;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 仅所有者可以添加白名单</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function addToWhitelist(address[] calldata addresses) external onlyOwner {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (uint256 i = 0; i &lt; addresses.length; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            whitelist[addresses[i]] = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="4-随机数可预测性">4. 随机数可预测性<a href="#4-随机数可预测性" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接" translate="no">​</a></h3>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 不安全的随机数生成</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">contract UnsafeRandom is ERC721 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function mintRandom() external {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 可预测！</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        uint256 randomId = uint256(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            keccak256(abi.encodePacked(block.timestamp, msg.sender))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ) % 10000;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _mint(msg.sender, randomId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 使用 Chainlink VRF 的安全实现</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import &quot;@chainlink/contracts/src/v0.8/VRFConsumerBase.sol&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">contract SecureRandomNFT is ERC721, VRFConsumerBase {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bytes32 internal keyHash;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint256 internal fee;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mapping(bytes32 =&gt; address) public requestToSender;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    constructor(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        address _vrfCoordinator,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        address _link,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bytes32 _keyHash,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        uint256 _fee</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ) VRFConsumerBase(_vrfCoordinator, _link) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        keyHash = _keyHash;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fee = _fee;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function requestRandomMint() external returns (bytes32) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        require(LINK.balanceOf(address(this)) &gt;= fee, &quot;Not enough LINK&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bytes32 requestId = requestRandomness(keyHash, fee);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        requestToSender[requestId] = msg.sender;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return requestId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function fulfillRandomness(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bytes32 requestId,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        uint256 randomness</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ) internal override {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        address sender = requestToSender[requestId];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        uint256 tokenId = randomness % 10000;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _mint(sender, tokenId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="真实攻击案例">真实攻击案例<a href="#真实攻击案例" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="akutars-nft-事件2022年4月">Akutars NFT 事件（2022年4月）<a href="#akutars-nft-事件2022年4月" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接" translate="no">​</a></h3>
<p><strong>损失</strong>：34 million 美元永久锁定</p>
<p><strong>问题代码：</strong></p>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">contract AkutarsVulnerable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint256 public totalRefundAmount;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function claimRefund() external {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        uint256 refundAmount = refunds[msg.sender];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        require(refundAmount &gt; 0, &quot;No refund available&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        refunds[msg.sender] = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        totalRefundAmount -= refundAmount;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 问题：需要所有人都claim才能提取</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        require(totalRefundAmount == 0, &quot;Not all refunds claimed&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        payable(owner).transfer(address(this).balance);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p><strong>问题分析：</strong></p>
<ul>
<li class="">合约要求所有退款都被领取后才能提取资金</li>
<li class="">如果有一个地址不领取退款，资金永久锁定</li>
<li class="">实际上有一  个地址无法领取，导致所有资金被锁</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="meebits-合约漏洞2021年5月">Meebits 合约漏洞（2021年5月）<a href="#meebits-合约漏洞2021年5月" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接" translate="no">​</a></h3>
<p><strong>漏洞类型</strong>：重入攻击</p>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 简化的漏洞代码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">contract MeebitsVulnerable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function mintWithPunk(uint256 punkIndex) external {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        require(punkOwner[punkIndex] == msg.sender, &quot;Not punk owner&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 先铸造NFT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _mint(msg.sender, nextTokenId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        nextTokenId++;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 后标记已使用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        punkUsed[punkIndex] = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p><strong>攻击方式：</strong>
攻击者可以在 <code>_mint</code> 的回调中再次调用 <code>mintWithPunk</code>，因为 <code>punkUsed</code> 还未设置。</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="安全最佳实践">安全最佳实践<a href="#安全最佳实践" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1-完整的访问控制">1. 完整的访问控制<a href="#1-完整的访问控制" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接" translate="no">​</a></h3>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">contract SecureNFTAccessControl is ERC721, AccessControl {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bytes32 public constant MINTER_ROLE = keccak256(&quot;MINTER_ROLE&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bytes32 public constant PAUSER_ROLE = keccak256(&quot;PAUSER_ROLE&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bool public paused;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    modifier whenNotPaused() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        require(!paused, &quot;Contract is paused&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function mint(address to, uint256 tokenId) external onlyRole(MINTER_ROLE) whenNotPaused {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _mint(to, tokenId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function pause() external onlyRole(PAUSER_ROLE) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        paused = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function unpause() external onlyRole(PAUSER_ROLE) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        paused = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="2-批  量操作的-gas-优化">2. 批量操作的 Gas 优化<a href="#2-批量操作的-gas-优化" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接" translate="no">​</a></h3>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">contract GasOptimizedNFT is ERC721A {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ERC721A 优化了批量铸造的 gas 消耗</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function batchMint(uint256 quantity) external payable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        require(quantity &lt;= 20, &quot;Max 20 per tx&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        require(msg.value &gt;= PRICE * quantity, &quot;Insufficient payment&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 单次调用铸造多个</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _mint(msg.sender, quantity);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="3-版税实现erc-2981">3. 版税  实现（ERC-2981）<a href="#3-版税实现erc-2981" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接" translate="no">​</a></h3>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import &quot;@openzeppelin/contracts/token/common/ERC2981.sol&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">contract NFTWithRoyalty is ERC721, ERC2981 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    constructor() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 设置默认版税：5%给创作者</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _setDefaultRoyalty(msg.sender, 500); // 500 = 5%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function setTokenRoyalty(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        uint256 tokenId,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        address receiver,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        uint96 feeNumerator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ) external onlyOwner {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _setTokenRoyalty(tokenId, receiver, feeNumerator);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function supportsInterface(bytes4 interfaceId)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        view</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        override(ERC721, ERC2981)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        returns (bool)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return super.supportsInterface(interfaceId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="4-元数据冻结机制">4. 元数据冻结机制<a href="#4-元数据冻结机制" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接" translate="no">​</a></h3>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">contract FreezableMetadata is ERC721 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mapping(uint256 =&gt; bool) public metadataFrozen;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mapping(uint256 =&gt; string) private _tokenURIs;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    event MetadataFrozen(uint256 indexed tokenId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function setTokenURI(uint256 tokenId, string memory uri) external onlyOwner {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        require(!metadataFrozen[tokenId], &quot;Metadata is frozen&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _tokenURIs[tokenId] = uri;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function freezeMetadata(uint256 tokenId) external onlyOwner {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        metadataFrozen[tokenId] = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        emit MetadataFrozen(tokenId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function tokenURI(uint256 tokenId) public view override returns (string memory) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        require(_exists(tokenId), &quot;Token does not exist&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return _tokenURIs[tokenId];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="审计清单">审计清单<a href="#审计清单" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接" translate="no">​</a></h2>
<p>在部署NFT合约前，确保检查：</p>
<ul>
<li class="">✅ 重入攻击防护</li>
<li class="">✅ 访问控制正确实现</li>
<li class="">✅ 元数据不可篡改或有冻结机制</li>
<li class="">✅ 随机数生成安全（使用VRF）</li>
<li class="">✅ 整数溢出保护（Solidity 0.8+自动检查）</li>
<li class="">✅ 紧急暂停机制</li>
<li class="">✅ 版税实现（如需要）</li>
<li class="">✅ Gas优化</li>
<li class="">✅ 事件日志完整</li>
<li class="">✅ 升级机制安全（如使用代理模式）</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="总结">总结<a href="#总结" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接" translate="no">​</a></h2>
<p>NFT安全需要关注：</p>
<ol>
<li class=""><strong>智能合约层面</strong>：防止重入、访问控制、随机数安全</li>
<li class=""><strong>元数据层面</strong>：确保不可篡改性和完整性</li>
<li class=""><strong>经济模型层面</strong>：防止价格操纵和套利</li>
<li class=""><strong>用户交互层面</strong>：防止钓鱼和社会工程攻击</li>
</ol>
<p>记住：<strong>一个  小漏洞可能导致整个NFT项目的崩溃</strong>。</p>
<hr>
<p><strong>AutoSec建议</strong>：在主网部署前，务必进行专业安全审计和充分测试。</p></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/tags/nft安全/">NFT安全</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/tags/erc-721/">ERC-721</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/tags/erc-1155/">ERC-1155</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/tags/智能合约/">智能合约</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/tags/web-3-安全/">Web3安全</a></li></ul></div></div><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col noPrint_WFHX"><a href="https://github.com/pfyangf/pfyangf.github.io/tree/main/blog/2025/02-02-nft-security-vulnerabilities.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><div style="margin-top:2rem;padding:1rem;border-top:1px solid var(--ifm-color-emphasis-200)"></div><nav class="pagination-nav docusaurus-mt-lg" aria-label="博客文章分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/cross-chain-bridge-security/"><div class="pagination-nav__sublabel">较新一篇</div><div class="pagination-nav__label">Cross-Chain Bridge Security: Vulnerabilities and Best Practices</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/react-hooks-guide/"><div class="pagination-nav__sublabel">较旧一篇</div><div class="pagination-nav__label">React Hooks 完全指南</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#nft标准概述" class="table-of-contents__link toc-highlight">NFT标准概述</a><ul><li><a href="#erc-721-vs-erc-1155" class="table-of-contents__link toc-highlight">ERC-721 vs ERC-1155</a></li></ul></li><li><a href="#常见安全漏洞" class="table-of-contents__link toc-highlight">常见安全漏洞</a><ul><li><a href="#1-重入攻击" class="table-of-contents__link toc-highlight">1. 重入攻击</a></li><li><a href="#2-元数据操纵" class="table-of-contents__link toc-highlight">2. 元数据操纵</a></li><li><a href="#3-访问控制漏洞" class="table-of-contents__link toc-highlight">3. 访问控制漏洞</a></li><li><a href="#4-随机数可预测性" class="table-of-contents__link toc-highlight">4. 随机数可预测性</a></li></ul></li><li><a href="#真实攻击案例" class="table-of-contents__link toc-highlight">真实攻击案例</a><ul><li><a href="#akutars-nft-事件2022年4月" class="table-of-contents__link toc-highlight">Akutars NFT 事件（2022年4月）</a></li><li><a href="#meebits-合约漏洞2021年5月" class="table-of-contents__link toc-highlight">Meebits 合约漏洞（2021年5月）</a></li></ul></li><li><a href="#安全最佳实践" class="table-of-contents__link toc-highlight">安全最佳实践</a><ul><li><a href="#1-完整的访问控制" class="table-of-contents__link toc-highlight">1. 完整的访问控制</a></li><li><a href="#2-批量操作的-gas-优化" class="table-of-contents__link toc-highlight">2. 批量操作的 Gas 优化</a></li><li><a href="#3-版税实现erc-2981" class="table-of-contents__link toc-highlight">3. 版税实现（ERC-2981）</a></li><li><a href="#4-元数据冻结机制" class="table-of-contents__link toc-highlight">4. 元数据冻结机制</a></li></ul></li><li><a href="#审计清单" class="table-of-contents__link toc-highlight">审计清单</a></li><li><a href="#总结" class="table-of-contents__link toc-highlight">总结</a></li></ul></div></div></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">博客</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/">最新文章</a></li><li class="footer__item"><a class="footer__link-item" href="/tags/">标签</a></li><li class="footer__item"><a class="footer__link-item" href="/archive/">归档</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">社交</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/your-org" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://twitter.com/yourhandle" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2026 AutoSec. Securing the Web3 Ecosystem.</div></div></div></footer></div>
</body>
</html>